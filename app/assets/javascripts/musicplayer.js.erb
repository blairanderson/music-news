function updateCurrentTrack (track) {
  $("#currentTrack").text(track.song.title);
  var nowplaying = " <a target='_blank' href=" + track.song.source_url + "><i class='icon-cloud'></i></a>";
  var target = $('[data-url="' + track.song.source_url+'"]');
  $('.row-fluid').removeClass('highlight');
  console.log(target);
  // target.addClass('highlight');
  // target.parent().addClass('highlight');
  $("#currentTrack").append(nowplaying);
};

function incrementPlaycount (track) {
  $.get(track.song.onfinish);
};

function playCurrentTrack (track) {
  SC.stream(track.song.stream_url, function(sound){
    updateCurrentTrack(track);
    sound.play({
      onfinish: function() {
        incrementPlaycount(track);
        $('#next').trigger('click');
      }
    });
  });
}

function advanceCurrentTrack (playlist, currentTrack) {
  SC.streamStopAll();
  return {song: playlist[currentTrack.index + 1], index: currentTrack.index + 1};
}

$(document).ready(function(){
  $('#music-player').affix();



  window.playlist = [];
  $.getJSON('/songs/playlist', function(data) {
    $.each(data, function(_i, song) {
      window.playlist.push(song);
    });
  });

  SC.whenStreamingReady( function() {
    console.log('Streaming ready.');
    var currentTrack = {song: window.playlist[0], index: 0};
    console.log("current track", currentTrack.song);

    updateCurrentTrack(currentTrack);

    $("#play").on("click", function(e){
      e.preventDefault();
      playCurrentTrack(currentTrack);
    });

    $('#stop').on('click', function(e) {
      e.preventDefault();
      SC.streamStopAll();
    });

    $('#next').on('click', function(e) {
      e.preventDefault();
      SC.streamStopAll();
      currentTrack = advanceCurrentTrack(window.playlist, currentTrack);
      playCurrentTrack(currentTrack);
    });
  });
});


